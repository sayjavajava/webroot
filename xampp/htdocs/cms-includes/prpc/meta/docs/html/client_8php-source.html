<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>PRPC: prpc/client.php Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.3 -->
<h1>prpc/client.php</h1><div class="fragment"><pre>00001 &lt;?php
<a name="l00017"></a><a class="code" href="classPrpc__Client.html">00017</a> <span class="keyword">class </span><a class="code" href="classPrpc__Client.html">Prpc_Client</a> <span class="keyword">extends</span> <a class="code" href="classPrpc__Base.html">Prpc_Base</a>
00018 {
00019     var $_prpc_url;
00020 
00021     function <a class="code" href="classPrpc__Client.html">Prpc_Client</a> ($url = NULL, $use_debug = FALSE, $use_trace = PRPC_TRACE_NONE)
00022     {
00023         $this-&gt;_Prpc_Set_Url ($url);
00024         $this-&gt;_prpc_use_debug = $use_debug;
00025         $this-&gt;_prpc_use_trace = $use_trace;
00026 
00027         <span class="keywordflow">switch</span> (TRUE)
00028         {
00029             <span class="keywordflow">case</span> (extension_loaded ('zlib') || @dl ('zlib')):
00030                 $this-&gt;_prpc_use_pack = PRPC_PACK_GZ;
00031                 <span class="keywordflow">break</span>;
00032             <span class="keywordflow">case</span> (extension_loaded ('bz2') || @dl ('bz2')):
00033                 $this-&gt;_prpc_use_pack = PRPC_PACK_BZ;
00034                 <span class="keywordflow">break</span>;
00035             <span class="keywordflow">default</span>:
00036                 $this-&gt;_prpc_use_pack = PRPC_PACK_NO;
00037         }
00038 
00039         $this-&gt;_Trace (3, PRPC_TRACE_FILE_CLIENT);
00040     }
00041 
00042     function _Prpc_Set_Url ($url = NULL)
00043     {
00044         <span class="keywordflow">if</span> (is_null ($url))
00045         {
00046             $this-&gt;_prpc_url = NULL;
00047             <span class="keywordflow">return</span> TRUE;
00048         }
00049 
00050         <span class="keywordflow">if</span> (! preg_match ('/^prpc:\/\/([^\/:]+)(?::(\d+))?(\/.*)?/', $url, $m))
00051         {
00052             die ('FATAL: Invalid url ('.$url.<span class="stringliteral">")\n"</span>);
00053         }
00054 
00055         $this-&gt;_prpc_url = $url;
00056         $this-&gt;_prpc_url_host = $m[1];
00057         $this-&gt;_prpc_url_port = $m[2] ? $m[2] : 80;
00058         $this-&gt;_prpc_url_path = $m[3];
00059 
00060         <span class="keywordflow">return</span> TRUE;
00061     }
00062 
00063     function _Prpc_Call ($call)
00064     {
00065         <span class="keywordflow">if</span> (! ($sock = @fsockopen ($this-&gt;_prpc_url_host, $this-&gt;_prpc_url_port, $errno, $errstr)))
00066         {
00067             echo 'WARN: fsockopen failed ', $errno, ' - ', $errstr, <span class="stringliteral">"\n"</span>;
00068             <span class="keywordflow">return</span> FALSE;
00069         }
00070 
00071         $content = $this-&gt;_Prpc_Pack ($call);
00072         $length = strlen ($content);
00073 
00074         $head =
00075             <span class="stringliteral">"POST "</span>.$this-&gt;_prpc_url_path.<span class="stringliteral">" HTTP/1.0\r\n"</span>.
00076             <span class="stringliteral">"Host: "</span>.$this-&gt;_prpc_url_host.<span class="stringliteral">"\r\n"</span>.
00077             <span class="stringliteral">"User-Agent: PRPC "</span>.PRPC_PROT_VER.<span class="stringliteral">"\r\n"</span>.
00078             <span class="stringliteral">"Connection: close\r\n"</span>.
00079             <span class="stringliteral">"Content-Type: form-data\r\n"</span>.
00080             <span class="stringliteral">"Content-Transfer-Encoding: binary\r\n"</span>.
00081             <span class="stringliteral">"Content-Length: "</span>.$length.<span class="stringliteral">"\r\n"</span>.
00082             <span class="stringliteral">"X-Prpc-Debug: "</span>.$this-&gt;_prpc_use_debug.<span class="stringliteral">"\r\n"</span>.
00083             <span class="stringliteral">"X-Prpc-Depth: "</span>.(@$_SERVER [<span class="stringliteral">"HTTP_X_PRPC_DEPTH"</span>] + 1).<span class="stringliteral">"\r\n"</span>.
00084             <span class="stringliteral">"X-Prpc-Pack: "</span>.$this-&gt;_prpc_use_pack.<span class="stringliteral">"\r\n"</span>.
00085             <span class="stringliteral">"X-Prpc-Trace: "</span>.$this-&gt;_prpc_use_trace.<span class="stringliteral">"\r\n"</span>.
00086             <span class="stringliteral">"\r\n"</span>;
00087 
00088         fwrite ($sock, $head.$content);
00089 
00090         $http_response_head = trim(fgets($sock));
00091         <span class="keywordflow">if</span> (! preg_match ('/^HTTP\/1\.\d (\d+) (.*)/', $http_response_head, $m))
00092         {
00093             die (<span class="stringliteral">"FATAL: No HTTP response header\n"</span>);
00094         }
00095         $http_response_code = $m[1];
00096         $http_response_msg = $m[2];
00097 
00098         <span class="keywordflow">while</span> (! feof ($sock) &amp;&amp; (($h = trim(fgets($sock))) != ''))
00099         {
00100             <span class="comment">// Could process other headers here</span>
00101             <span class="comment">// echo "HEAD: ", $h, "\n";</span>
00102         }
00103 
00104         <span class="comment">// Read in the rest</span>
00105         <span class="keywordflow">for</span> ($pack = '' ; ! feof ($sock) ; )
00106         {
00107             $pack .= fread ($sock, 2048);
00108         }
00109         fclose ($sock);
00110 
00111         <span class="keywordflow">if</span> ($http_response_code != 200)
00112         {
00113             die (<span class="stringliteral">"FATAL: Bad HTTP response "</span>.$http_response_code.<span class="stringliteral">" - "</span>.$http_response_msg.<span class="stringliteral">"\n"</span>.$pack.<span class="stringliteral">"\n"</span>);
00114         }
00115 
00116         $this-&gt;_Trace (3, PRPC_TRACE_CALL|PRPC_TRACE_ARGS, $call);
00117 
00118         $rpc = $this-&gt;_Prpc_Unpack ($pack);
00119 
00120         <span class="keywordflow">if</span> (! is_a ($rpc, '<a class="code" href="classPrpc__Message.html">Prpc_Message</a>'))
00121         {
00122              print_r ($pack); flush();
00123              die (<span class="stringliteral">"FATAL: Did not recieve a Prpc_Message\n"</span>);
00124         }
00125 
00126         $rpc-&gt;debug = preg_replace (<span class="stringliteral">"/(.*?)\n/s"</span>, <span class="stringliteral">"\t\\1\n"</span>, $rpc-&gt;debug);
00127 
00128         <span class="keywordflow">if</span> (@$_SERVER [<span class="stringliteral">"HTTP_X_PRPC_DEPTH"</span>])
00129         {
00130             echo $rpc-&gt;debug;
00131             $this-&gt;_Trace (3, PRPC_TRACE_RESULT, array ('method' =&gt; $call-&gt;method, 'result' =&gt; $rpc-&gt;result));
00132             <span class="keywordflow">return</span> isset ($rpc-&gt;result) ? $rpc-&gt;result : $rpc;
00133         }
00134         <span class="keywordflow">else</span>
00135         {
00136             $this-&gt;_prpc_debug .= $rpc-&gt;debug;
00137             $this-&gt;_Trace (3, PRPC_TRACE_RESULT, array ('method' =&gt; $call-&gt;method, 'result' =&gt; $rpc-&gt;result));
00138             <span class="keywordflow">if</span> (is_a ($rpc, 'prpc_fault'))
00139             {
00140                 print_r ($rpc);
00141                 echo <span class="stringliteral">"\n"</span>, $this-&gt;_prpc_debug, <span class="stringliteral">"\n\n"</span>;
00142                 exit;
00143             }
00144         }
00145     }
00146 
00147 
00148     function __call ($method, $arg, &amp;$result)
00149     {
00150         <span class="keywordflow">if</span> (method_exists ($<span class="keyword">this</span>, $method))
00151         {
00152             $result = call_user_func_array (array (&amp;$<span class="keyword">this</span>, $method), $arg);
00153             <span class="keywordflow">return</span> TRUE;
00154         }
00155 
00156         $result = $this-&gt;_Prpc_Call (<span class="keyword">new</span> <a class="code" href="classPrpc__Call.html">Prpc_Call</a> ($method, $arg));
00157         <span class="keywordflow">return</span> TRUE;
00158     }
00159 }
00160 
00161 overload ('<a class="code" href="classPrpc__Client.html">Prpc_Client</a>');
00162 
00163 ?&gt;
</pre></div>	<hr size="1">
	<address style="align: right;">
		<small>Generated on Fri Jul 18 15:03:44 2003</small>
	</address>
</body>
</html>
