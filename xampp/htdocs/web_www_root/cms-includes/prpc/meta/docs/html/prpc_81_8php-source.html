<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>PRPC: prpc.1.php Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.3 -->
<h1>prpc.1.php</h1><div class="fragment"><pre>00001 &lt;?php
00002 
00003 <span class="keywordflow">if</span> (! function_exists ('version_compare') || version_compare (phpversion (), '4.3.2', <span class="charliteral">'&lt;'</span>))
00004 {
00005     die(<span class="stringliteral">"Requires PHP 4.3.2 or higher\n"</span>);
00006 }
00007 
00008 define ('PRPC_PROT_VER', '1.0');
00009 
00010 define ('PRPC_PACK_NO', 0);
00011 define ('PRPC_PACK_GZ', 1);
00012 define ('PRPC_PACK_BZ', 2);
00013 
00014 define ('PRPC_TRACE_NONE', 0);
00015 define ('PRPC_TRACE_CALL', 1);
00016 define ('PRPC_TRACE_ARGS', 2);
00017 define ('PRPC_TRACE_FILE_CLIENT', 4);
00018 define ('PRPC_TRACE_FILE_SERVER', 8);
00019 define ('PRPC_TRACE_RESULT', 16);
00020 
00021 define ('PRPC_TRACE_FILE', PRPC_TRACE_FILE_CLIENT + PRPC_TRACE_FILE_SERVER);
00022 
00023 
<a name="l00039"></a><a class="code" href="classPrpc__Message.html">00039</a> <span class="keyword">class </span><a class="code" href="classPrpc__Message.html">Prpc_Message</a>
00040 {
00041 }
00042 
<a name="l00058"></a><a class="code" href="classPrpc__Call.html">00058</a> <span class="keyword">class </span><a class="code" href="classPrpc__Call.html">Prpc_Call</a> <span class="keyword">extends</span> <a class="code" href="classPrpc__Message.html">Prpc_Message</a>
00059 {
00060     function <a class="code" href="classPrpc__Call.html">Prpc_Call</a> ($method, $arg)
00061     {
00062         $this-&gt;method = $method;
00063         $this-&gt;arg = $arg;
00064     }
00065 }
00066 
<a name="l00082"></a><a class="code" href="classPrpc__Result.html">00082</a> <span class="keyword">class </span><a class="code" href="classPrpc__Result.html">Prpc_Result</a> <span class="keyword">extends</span> <a class="code" href="classPrpc__Message.html">Prpc_Message</a>
00083 {
00084     function <a class="code" href="classPrpc__Result.html">Prpc_Result</a> ($result, $debug)
00085     {
00086         $this-&gt;result = $result;
00087         $this-&gt;debug = $debug;
00088     }
00089 }
00090 
<a name="l00106"></a><a class="code" href="classPrpc__Notice.html">00106</a> <span class="keyword">class </span><a class="code" href="classPrpc__Notice.html">Prpc_Notice</a> <span class="keyword">extends</span> <a class="code" href="classPrpc__Message.html">Prpc_Message</a>
00107 {
00108     function <a class="code" href="classPrpc__Notice.html">Prpc_Notice</a> ($url, $method, $arg)
00109     {
00110         $this-&gt;url = $url;
00111         $this-&gt;method = $method;
00112         $this-&gt;arg = $arg;
00113     }
00114 }
00115 
<a name="l00131"></a><a class="code" href="classPrpc__Fault.html">00131</a> <span class="keyword">class </span><a class="code" href="classPrpc__Fault.html">Prpc_Fault</a> <span class="keyword">extends</span> <a class="code" href="classPrpc__Message.html">Prpc_Message</a>
00132 {
00133     function <a class="code" href="classPrpc__Fault.html">Prpc_Fault</a> ($code, $text, $file, $line, $debug)
00134     {
00135         $this-&gt;code = $code;
00136         $this-&gt;text = $text;
00137         $this-&gt;file = $file;
00138         $this-&gt;line = $line;
00139         $this-&gt;debug = $debug;
00140     }
00141 }
00142 
00143 
<a name="l00159"></a><a class="code" href="classPrpc__Base.html">00159</a> <span class="keyword">class </span><a class="code" href="classPrpc__Base.html">Prpc_Base</a>
00160 {
00161     var $_prpc_use_pack;
00162     var $_prpc_use_debug;
00163     var $_prpc_use_trace;
00164 
00165     var $_prpc_debug;
00166 
00167     function _Prpc_Pack ($data)
00168     {
00169         <span class="keywordflow">switch</span> ($this-&gt;_prpc_use_pack)
00170         {
00171             <span class="keywordflow">case</span> PRPC_PACK_GZ:
00172                 $pack = gzcompress (serialize ($data));
00173                 <span class="keywordflow">break</span>;
00174             <span class="keywordflow">case</span> PRPC_PACK_BZ:
00175                 $pack = bzcompress (serialize ($data));
00176                 <span class="keywordflow">break</span>;
00177             <span class="keywordflow">default</span>:
00178                 $pack = serialize ($data);
00179         }
00180         <span class="keywordflow">return</span> $pack;
00181     }
00182 
00183     function _Prpc_Unpack ($pack)
00184     {
00185         <span class="keywordflow">switch</span> ($this-&gt;_prpc_use_pack)
00186         {
00187             <span class="keywordflow">case</span> PRPC_PACK_GZ:
00188                 $data = @gzuncompress ($pack);
00189                 <span class="keywordflow">break</span>;
00190             <span class="keywordflow">case</span> PRPC_PACK_BZ:
00191                 $data = @bzdecompress ($pack);
00192                 <span class="keywordflow">break</span>;
00193             <span class="keywordflow">default</span>:
00194                 $data = $pack;
00195         }
00196 
00197         <span class="keywordflow">return</span> unserialize ($data);
00198     }
00199 
00200     function _Prpc_Get_Host ()
00201     {
00202         <span class="keywordflow">if</span> (! isset ($this-&gt;_prpc_get_host_cache))
00203         {
00204             ob_start ();
00205             $rc = system ('hostname -f');
00206             $ob = trim (ob_get_clean ());
00207             $this-&gt;_prpc_get_host_cache = ($rc === FALSE ? $_SERVER['SERVER_NAME'] : $ob);
00208         }
00209         <span class="keywordflow">return</span> $this-&gt;_prpc_get_host_cache;
00210     }
00211 
00212     function _Debug ($msg, $type = NULL)
00213     {
00214         <span class="keywordflow">if</span> (@$_SERVER [<span class="stringliteral">"HTTP_X_PRPC_DEPTH"</span>])
00215         {
00216             echo $msg, <span class="stringliteral">"\n"</span>;
00217         }
00218         <span class="keywordflow">else</span>
00219         {
00220             $this-&gt;_prpc_debug .= $msg.<span class="stringliteral">"\n"</span>;
00221         }
00222     }
00223 
00224     function _Trace ($frame, $type, $opt = NULL)
00225     {
00226         <span class="keywordflow">if</span> (($type = ($this-&gt;_prpc_use_trace &amp; $type)))
00227         {
00228             $btrace = debug_backtrace ();
00229             $host = $this-&gt;_Prpc_Get_Host ();
00230             $level = number_format (@$_SERVER ['HTTP_X_PRPC_DEPTH']);
00231 
00232             <span class="keywordflow">switch</span> ($type)
00233             {
00234                 <span class="keywordflow">case</span> PRPC_TRACE_ARGS:
00235                     ob_start (); print_r ($btrace[$frame]['args']); $args = ob_get_clean ();
00236                     $this-&gt;_Debug (<span class="stringliteral">"\nTRACE:"</span>.$level.<span class="stringliteral">":PRPC_ARGS @ "</span>.$host.<span class="stringliteral">":"</span>.$btrace[$frame]['file'].<span class="stringliteral">", line = "</span>.$btrace[$frame]['line'].<span class="stringliteral">", method = "</span>.ucwords($opt-&gt;method).<span class="stringliteral">"(), target = "</span>.$this-&gt;_prpc_url.<span class="stringliteral">"\n"</span>.$args.<span class="stringliteral">"\n"</span>);
00237                     <span class="keywordflow">break</span>;
00238 
00239                 <span class="keywordflow">case</span> PRPC_TRACE_RESULT:
00240                     ob_start (); print_r ($opt['result']); $res = ob_get_clean ();
00241                     $this-&gt;_Debug (<span class="stringliteral">"\nTRACE:"</span>.$level.<span class="stringliteral">":PRPC_RESULT @ "</span>.$host.<span class="stringliteral">":"</span>.$btrace[$frame]['file'].<span class="stringliteral">", line = "</span>.$btrace[$frame]['line'].<span class="stringliteral">", method = "</span>.ucwords($opt['method']).<span class="stringliteral">"(), target = "</span>.$this-&gt;_prpc_url.<span class="stringliteral">"\n"</span>.$res.<span class="stringliteral">"\n"</span>);
00242                     <span class="keywordflow">break</span>;
00243 
00244                 <span class="keywordflow">case</span> PRPC_TRACE_CALL:
00245                     $this-&gt;_Debug (<span class="stringliteral">"\nTRACE:"</span>.$level.<span class="stringliteral">":PRPC_CALL @ "</span>.$host.<span class="stringliteral">":"</span>.$btrace[$frame]['file'].<span class="stringliteral">", line = "</span>.$btrace[$frame]['line'].<span class="stringliteral">", method = "</span>.ucwords($opt-&gt;method).<span class="stringliteral">"(), target = "</span>.$this-&gt;_prpc_url);
00246                     <span class="keywordflow">break</span>;
00247 
00248                 <span class="keywordflow">case</span> PRPC_TRACE_FILE_SERVER:
00249                     $this-&gt;_Debug (<span class="stringliteral">"\nTRACE:"</span>.$level.<span class="stringliteral">":PRPC_SERVER @ "</span>.$host.<span class="stringliteral">":"</span>.$btrace[$frame]['file'].<span class="stringliteral">", line = "</span>.$btrace[$frame]['line'].<span class="stringliteral">", method = "</span>.ucwords($opt-&gt;method).<span class="stringliteral">"()"</span>);
00250                     <span class="keywordflow">break</span>;
00251 
00252                 <span class="keywordflow">case</span> PRPC_TRACE_FILE_CLIENT:
00253                     if (! $level)
00254                         $this-&gt;_Debug (<span class="stringliteral">"\nTRACE:"</span>.$level.<span class="stringliteral">":PRPC_CLIENT @ "</span>.$host.<span class="stringliteral">":"</span>.$btrace[$frame]['file'].<span class="stringliteral">", line = "</span>.$btrace[$frame]['line']);
00255                     <span class="keywordflow">break</span>;
00256             }
00257         }
00258     }
00259 }
00260 
<a name="l00276"></a><a class="code" href="classPrpc__Client.html">00276</a> <span class="keyword">class </span><a class="code" href="classPrpc__Client.html">Prpc_Client</a> <span class="keyword">extends</span> <a class="code" href="classPrpc__Base.html">Prpc_Base</a>
00277 {
00278     var $_prpc_url;
00279 
00280     function <a class="code" href="classPrpc__Client.html">Prpc_Client</a> ($url = NULL, $use_debug = FALSE, $use_trace = PRPC_TRACE_NONE)
00281     {
00282         $this-&gt;_Prpc_Set_Url ($url);
00283         $this-&gt;_prpc_use_debug = $use_debug;
00284         $this-&gt;_prpc_use_trace = $use_trace;
00285 
00286         <span class="keywordflow">switch</span> (TRUE)
00287         {
00288             <span class="keywordflow">case</span> (extension_loaded ('zlib') || @dl ('zlib')):
00289                 $this-&gt;_prpc_use_pack = PRPC_PACK_GZ;
00290                 <span class="keywordflow">break</span>;
00291             <span class="keywordflow">case</span> (extension_loaded ('bz2') || @dl ('bz2')):
00292                 $this-&gt;_prpc_use_pack = PRPC_PACK_BZ;
00293                 <span class="keywordflow">break</span>;
00294             <span class="keywordflow">default</span>:
00295                 $this-&gt;_prpc_use_pack = PRPC_PACK_NO;
00296         }
00297 
00298         $this-&gt;_Trace (3, PRPC_TRACE_FILE_CLIENT);
00299     }
00300 
00301     function _Prpc_Set_Url ($url = NULL)
00302     {
00303         <span class="keywordflow">if</span> (is_null ($url))
00304         {
00305             $this-&gt;_prpc_url = NULL;
00306             <span class="keywordflow">return</span> TRUE;
00307         }
00308 
00309         <span class="keywordflow">if</span> (! preg_match ('/^prpc:\/\/([^\/:]+)(?::(\d+))?(\/.*)?/', $url, $m))
00310         {
00311             die ('FATAL: Invalid url ('.$url.<span class="stringliteral">")\n"</span>);
00312         }
00313 
00314         $this-&gt;_prpc_url = $url;
00315         $this-&gt;_prpc_url_host = $m[1];
00316         $this-&gt;_prpc_url_port = $m[2] ? $m[2] : 80;
00317         $this-&gt;_prpc_url_path = $m[3];
00318 
00319         <span class="keywordflow">return</span> TRUE;
00320     }
00321 
00322     function _Prpc_Call ($call)
00323     {
00324         <span class="keywordflow">if</span> (! ($sock = @fsockopen ($this-&gt;_prpc_url_host, $this-&gt;_prpc_url_port, $errno, $errstr)))
00325         {
00326             echo 'WARN: fsockopen failed ', $errno, ' - ', $errstr, <span class="stringliteral">"\n"</span>;
00327             <span class="keywordflow">return</span> FALSE;
00328         }
00329 
00330         $content = $this-&gt;_Prpc_Pack ($call);
00331         $length = strlen ($content);
00332 
00333         $head =
00334             <span class="stringliteral">"POST "</span>.$this-&gt;_prpc_url_path.<span class="stringliteral">" HTTP/1.0\r\n"</span>.
00335             <span class="stringliteral">"Host: "</span>.$this-&gt;_prpc_url_host.<span class="stringliteral">"\r\n"</span>.
00336             <span class="stringliteral">"User-Agent: PRPC "</span>.PRPC_PROT_VER.<span class="stringliteral">"\r\n"</span>.
00337             <span class="stringliteral">"Connection: close\r\n"</span>.
00338             <span class="stringliteral">"Content-Type: form-data\r\n"</span>.
00339             <span class="stringliteral">"Content-Transfer-Encoding: binary\r\n"</span>.
00340             <span class="stringliteral">"Content-Length: "</span>.$length.<span class="stringliteral">"\r\n"</span>.
00341             <span class="stringliteral">"X-Prpc-Debug: "</span>.$this-&gt;_prpc_use_debug.<span class="stringliteral">"\r\n"</span>.
00342             <span class="stringliteral">"X-Prpc-Depth: "</span>.(@$_SERVER [<span class="stringliteral">"HTTP_X_PRPC_DEPTH"</span>] + 1).<span class="stringliteral">"\r\n"</span>.
00343             <span class="stringliteral">"X-Prpc-Pack: "</span>.$this-&gt;_prpc_use_pack.<span class="stringliteral">"\r\n"</span>.
00344             <span class="stringliteral">"X-Prpc-Trace: "</span>.$this-&gt;_prpc_use_trace.<span class="stringliteral">"\r\n"</span>.
00345             <span class="stringliteral">"\r\n"</span>;
00346 
00347         fwrite ($sock, $head.$content);
00348 
00349         $http_response_head = trim(fgets($sock));
00350         <span class="keywordflow">if</span> (! preg_match ('/^HTTP\/1\.\d (\d+) (.*)/', $http_response_head, $m))
00351         {
00352             die (<span class="stringliteral">"FATAL: No HTTP response header\n"</span>);
00353         }
00354         $http_response_code = $m[1];
00355         $http_response_msg = $m[2];
00356 
00357         <span class="keywordflow">while</span> (! feof ($sock) &amp;&amp; (($h = trim(fgets($sock))) != ''))
00358         {
00359             <span class="comment">// Could process other headers here</span>
00360             <span class="comment">// echo "HEAD: ", $h, "\n";</span>
00361         }
00362 
00363         <span class="comment">// Read in the rest</span>
00364         <span class="keywordflow">for</span> ($pack = '' ; ! feof ($sock) ; )
00365         {
00366             $pack .= fread ($sock, 2048);
00367         }
00368         fclose ($sock);
00369 
00370         <span class="keywordflow">if</span> ($http_response_code != 200)
00371         {
00372             die (<span class="stringliteral">"FATAL: Bad HTTP response "</span>.$http_response_code.<span class="stringliteral">" - "</span>.$http_response_msg.<span class="stringliteral">"\n"</span>.$pack.<span class="stringliteral">"\n"</span>);
00373         }
00374 
00375         $this-&gt;_Trace (3, PRPC_TRACE_CALL|PRPC_TRACE_ARGS, $call);
00376 
00377         $rpc = $this-&gt;_Prpc_Unpack ($pack);
00378 
00379         <span class="keywordflow">if</span> (! is_a ($rpc, '<a class="code" href="classPrpc__Message.html">Prpc_Message</a>'))
00380         {
00381              print_r ($pack); flush();
00382              die (<span class="stringliteral">"FATAL: Did not recieve a Prpc_Message\n"</span>);
00383         }
00384 
00385         $rpc-&gt;debug = preg_replace (<span class="stringliteral">"/(.*?)\n/s"</span>, <span class="stringliteral">"\t\\1\n"</span>, $rpc-&gt;debug);
00386 
00387         <span class="keywordflow">if</span> (@$_SERVER [<span class="stringliteral">"HTTP_X_PRPC_DEPTH"</span>])
00388         {
00389             echo $rpc-&gt;debug;
00390             $this-&gt;_Trace (3, PRPC_TRACE_RESULT, array ('method' =&gt; $call-&gt;method, 'result' =&gt; $rpc-&gt;result));
00391             <span class="keywordflow">return</span> isset ($rpc-&gt;result) ? $rpc-&gt;result : $rpc;
00392         }
00393         <span class="keywordflow">else</span>
00394         {
00395             $this-&gt;_prpc_debug .= $rpc-&gt;debug;
00396             $this-&gt;_Trace (3, PRPC_TRACE_RESULT, array ('method' =&gt; $call-&gt;method, 'result' =&gt; $rpc-&gt;result));
00397             <span class="keywordflow">if</span> (is_a ($rpc, 'prpc_fault'))
00398             {
00399                 print_r ($rpc);
00400                 echo <span class="stringliteral">"\n"</span>, $this-&gt;_prpc_debug, <span class="stringliteral">"\n\n"</span>;
00401                 exit;
00402             }
00403         }
00404     }
00405 
00406 
00407     function __call ($method, $arg, &amp;$result)
00408     {
00409         <span class="keywordflow">if</span> (method_exists ($<span class="keyword">this</span>, $method))
00410         {
00411             $result = call_user_func_array (array (&amp;$<span class="keyword">this</span>, $method), $arg);
00412             <span class="keywordflow">return</span> TRUE;
00413         }
00414 
00415         $result = $this-&gt;_Prpc_Call (<span class="keyword">new</span> <a class="code" href="classPrpc__Call.html">Prpc_Call</a> ($method, $arg));
00416         <span class="keywordflow">return</span> TRUE;
00417     }
00418 }
00419 
<a name="l00435"></a><a class="code" href="classPrpc__Server.html">00435</a> <span class="keyword">class </span><a class="code" href="classPrpc__Server.html">Prpc_Server</a> <span class="keyword">extends</span> <a class="code" href="classPrpc__Base.html">Prpc_Base</a>
00436 {
00437     function <a class="code" href="classPrpc__Server.html">Prpc_Server</a> ($process = TRUE)
00438     {
00439         $this-&gt;_prpc_use_pack = @$_SERVER ['HTTP_X_PRPC_PACK'];
00440         $this-&gt;_prpc_use_debug = @$_SERVER ['HTTP_X_PRPC_DEBUG'];
00441         $this-&gt;_prpc_use_trace = @$_SERVER ['HTTP_X_PRPC_TRACE'];
00442 
00443         ini_set ('display_errors', 0);
00444         set_error_handler (array (&amp;$<span class="keyword">this</span>, '_Error_Handler'));
00445 
00446         <span class="keywordflow">if</span> ($process)
00447             $this-&gt;Prpc_Process ();
00448     }
00449 
00450     function Prpc_Process ()
00451     {
00452         ob_start ();
00453         $call = $this-&gt;_Prpc_Unpack ($GLOBALS['HTTP_RAW_POST_DATA']);
00454 
00455         $this-&gt;_Trace (2, PRPC_TRACE_FILE_SERVER, $call);
00456 
00457         <span class="keywordflow">if</span> (method_exists ($<span class="keyword">this</span>, $call-&gt;method))
00458         {
00459             $result = call_user_func_array (array (&amp;$<span class="keyword">this</span>, $call-&gt;method), $call-&gt;arg);
00460         }
00461         <span class="keywordflow">else</span>
00462         {
00463             $result = 'unknown method';
00464         }
00465 
00466         $this-&gt;_prpc_debug = ob_get_clean ();
00467 
00468         echo $this-&gt;_Prpc_Pack (<span class="keyword">new</span> <a class="code" href="classPrpc__Result.html">Prpc_Result</a> ($result, $this-&gt;_prpc_debug));
00469         exit (0);
00470     }
00471 
00472     function &amp; Prpc_Proxy ($url)
00473     {
00474         <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classPrpc__Client.html">Prpc_Client</a> ($url, $this-&gt;_prpc_use_debug, $this-&gt;_prpc_use_trace);
00475     }
00476 
00477     function _Error_Handler ($errno, $errstr, $errfile, $errline)
00478     {
00479         echo $this-&gt;_Prpc_Pack (<span class="keyword">new</span> <a class="code" href="classPrpc__Fault.html">Prpc_Fault</a> ($errno, $errstr, $errfile, $errline, $this-&gt;_prpc_debug));
00480         exit (0);
00481     }
00482 }
00483 
00484 overload ('<a class="code" href="classPrpc__Client.html">Prpc_Client</a>');
00485 
00486 ?&gt;
</pre></div>	<hr size="1">
	<address style="align: right;">
		<small>Generated on Fri Jul 18 15:03:44 2003</small>
	</address>
</body>
</html>
